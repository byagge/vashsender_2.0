# Руководство по обновлению тарифов

## Проблема

При добавлении новых тарифов (до 1 млн писем/подписчиков) возникает проблема с ID тарифов. Если в базе уже есть тарифы с ID 1-7, то новые тарифы будут создаваться с ID 8 и далее, что может нарушить логику в `pricing.html`.

## Решения

### Вариант 1: Полный сброс (рекомендуется для разработки)

Если у вас нет важных данных о купленных тарифах, используйте полный сброс:

```bash
# Полный сброс всех тарифов
python manage.py reset_pricing --force

# Создание новых тарифов с ID начиная с 1
python manage.py init_pricing
```

### Вариант 2: Миграция с сохранением данных (для продакшена)

Если у вас есть купленные тарифы, которые нужно сохранить:

```bash
# Сначала посмотрите что будет изменено
python manage.py migrate_pricing --dry-run

# Если всё устраивает, запустите миграцию
python manage.py migrate_pricing
```

### Вариант 3: Обновление существующих тарифов

Если нужно просто добавить новые тарифы к существующим:

```bash
# Обновление существующих и добавление новых тарифов
python manage.py init_pricing
```

## Новые тарифы

### Тарифы по подписчикам (1,000 - 1,000,000)

- **Малые тарифы**: 1K, 2K, 3K, 4K, 5K, 6K, 7K, 8K, 9K, 10K
- **Средние тарифы**: 15K, 20K, 25K, 30K, 35K, 40K, 45K, 50K, 60K, 70K, 80K, 90K, 100K
- **Большие тарифы**: 150K, 200K, 250K, 300K, 350K, 400K, 450K, 500K, 600K, 700K, 800K, 900K, 1M

### Тарифы по письмам (1,000 - 1,000,000)

- **Малые пакеты**: 1K, 2K, 3K, 4K, 5K, 6K, 7K, 8K, 9K, 10K
- **Средние пакеты**: 15K, 20K, 25K, 30K, 35K, 40K, 45K, 50K, 60K, 70K, 80K, 90K, 100K
- **Большие пакеты**: 150K, 200K, 250K, 300K, 350K, 400K, 450K, 500K, 600K, 700K, 800K, 900K, 1M

## Дневные лимиты для тарифов по подписчикам

- До 1K подписчиков: 200 писем/день
- До 5K подписчиков: 500 писем/день
- До 10K подписчиков: 1,000 писем/день
- До 50K подписчиков: 2,000 писем/день
- До 100K подписчиков: 5,000 писем/день
- До 500K подписчиков: 10,000 писем/день
- Более 500K подписчиков: 20,000 писем/день

## Обновления в pricing.html

1. **Улучшенные слайдеры**: добавлены промежуточные значения (50K, 500K)
2. **Адаптивные шаги**: шаг слайдера зависит от диапазона
3. **Улучшенная интерполяция**: корректная работа с граничными значениями

## Проверка результатов

После обновления тарифов проверьте:

```bash
# Проверка количества тарифов
python manage.py shell
```

```python
from apps.billing.models import Plan, PlanType

# Подсчет тарифов
print(f"Всего тарифов: {Plan.objects.count()}")
print(f"По подписчикам: {Plan.objects.filter(plan_type__name='Subscribers').count()}")
print(f"По письмам: {Plan.objects.filter(plan_type__name='Letters').count()}")

# Проверка диапазонов
subscribers_plans = Plan.objects.filter(plan_type__name='Subscribers').order_by('subscribers')
print(f"Подписчики: {subscribers_plans.first().subscribers:,} - {subscribers_plans.last().subscribers:,}")

letters_plans = Plan.objects.filter(plan_type__name='Letters').order_by('emails_per_month')
print(f"Письма: {letters_plans.first().emails_per_month:,} - {letters_plans.last().emails_per_month:,}")
```

## Команды для управления

### Обновление счётчиков писем

```bash
# Обновить счётчики для всех пользователей
python manage.py update_email_counts

# Обновить счётчики для конкретного пользователя
python manage.py update_email_counts --user user@example.com

# Предварительный просмотр изменений
python manage.py update_email_counts --dry-run
```

### Тестирование системы

```bash
# Запуск тестов системы учёта писем
python test_email_limits.py
```

## Важные замечания

1. **Резервное копирование**: Перед выполнением команд сделайте резервную копию базы данных
2. **Тестирование**: Сначала протестируйте на тестовой среде
3. **Время простоя**: Миграция может занять время, планируйте время простоя
4. **Уведомления**: Уведомите пользователей о возможных изменениях в тарифах

## Структура ID после обновления

После выполнения `reset_pricing` + `init_pricing`:

- ID 1: Бесплатный тариф
- ID 2-34: Тарифы по подписчикам (1K - 1M)
- ID 35-67: Тарифы по письмам (1K - 1M)

Всего: 67 тарифов 