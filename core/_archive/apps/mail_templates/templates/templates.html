<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Шаблоны</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons (CDN) -->
  <script defer src="https://unpkg.com/lucide@0.276.0/dist/umd/lucide.min.js"></script>
  <!-- Alpine.js CDN -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- CKEditor 5 CDN -->
  <script src="https://cdn.ckeditor.com/ckeditor5/40.1.0/decoupled-document/ckeditor.js"></script>
  <script>
    // Проверяем загрузку CKEditor
    window.addEventListener('load', function() {
      if (window.DecoupledEditor) {
        console.log('CKEditor loaded successfully');
      } else {
        console.error('CKEditor failed to load');
      }
    });
  </script>
  <style>
    .ck-editor__editable {
      min-height: 400px;
      max-height: 800px;
    }
    .ck.ck-editor {
      width: 100%;
      height: 100%;
    }
    .ck.ck-editor__main {
      height: calc(100% - 60px);
    }
    .ck.ck-editor__editable {
      height: 100%;
    }
    .ck.ck-toolbar {
      border-radius: 0.5rem 0.5rem 0 0;
      border: 1px solid #e5e7eb;
      border-bottom: none;
    }
    .ck.ck-editor__editable {
      border-radius: 0 0 0.5rem 0.5rem;
      border: 1px solid #e5e7eb;
      border-top: none;
    }
    .ck.ck-toolbar__items {
      flex-wrap: wrap;
    }
    .ck.ck-toolbar__items > * {
      margin: 2px;
    }
    .ck.ck-content {
      font-size: 16px;
      line-height: 1.6;
    }
    .ck.ck-content p {
      margin: 1em 0;
    }
    .ck.ck-content h1,
    .ck.ck-content h2,
    .ck.ck-content h3,
    .ck.ck-content h4,
    .ck.ck-content h5,
    .ck.ck-content h6 {
      margin: 1em 0 0.5em;
    }
    .ck.ck-content ul,
    .ck.ck-content ol {
      margin: 1em 0;
      padding-left: 2em;
    }
    .ck.ck-content blockquote {
      margin: 1em 0;
      padding-left: 1em;
      border-left: 3px solid #e5e7eb;
    }
    .ck.ck-content table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
    }
    .ck.ck-content table td,
    .ck.ck-content table th {
      border: 1px solid #e5e7eb;
      padding: 0.5em;
    }
    .ck.ck-content table th {
      background-color: #f8f9fa;
      font-weight: bold;
    }
    .ck.ck-content table tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    .ck.ck-content table tr:hover {
      background-color: #f0f4ff;
    }
    .ck.ck-content .image {
      margin: 1em 0;
    }
    .ck.ck-content .image img {
      max-width: 100%;
      height: auto;
    }
    .ck.ck-content .image-style-side {
      float: right;
      margin-left: 1em;
      max-width: 50%;
    }
    .ck.ck-content .image-style-block {
      margin: 0 auto;
      max-width: 100%;
    }
    .ck.ck-content .code-block {
      background: #f8f9fa;
      padding: 1em;
      border-radius: 0.5em;
      font-family: monospace;
    }
    .ck.ck-content .page-break {
      border-top: 2px dashed #e5e7eb;
      margin: 1em 0;
    }
    .ck.ck-content .special-character {
      font-family: monospace;
      padding: 0.2em;
      background: #f8f9fa;
      border-radius: 0.2em;
    }
    .ck.ck-content .highlight {
      background: #fff3cd;
      padding: 0.2em;
    }
    .ck.ck-content .text-small {
      font-size: 0.875em;
    }
    .ck.ck-content .text-large {
      font-size: 1.25em;
    }
    .ck.ck-content .text-muted {
      color: #6c757d;
    }
    .ck.ck-content .text-primary {
      color: #0d6efd;
    }
    .ck.ck-content .text-success {
      color: #198754;
    }
    .ck.ck-content .text-danger {
      color: #dc3545;
    }
    .ck.ck-content .text-warning {
      color: #ffc107;
    }
    .ck.ck-content .text-info {
      color: #0dcaf0;
    }
    .ck.ck-content .bg-light {
      background-color: #f8f9fa;
    }
    .ck.ck-content .bg-dark {
      background-color: #212529;
      color: #fff;
    }
    .ck.ck-content .border {
      border: 1px solid #dee2e6;
    }
    .ck.ck-content .rounded {
      border-radius: 0.25rem;
    }
    .ck.ck-content .shadow {
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    /* Стили для превью */
    .preview-content {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      color: #333;
    }
    .preview-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 1em 0;
    }
    .preview-content table td,
    .preview-content table th {
      border: 1px solid #e5e7eb;
      padding: 0.5em;
    }
    .preview-content table th {
      background-color: #f8f9fa;
      font-weight: bold;
    }
    .preview-content table tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    .preview-content table tr:hover {
      background-color: #f0f4ff;
    }
    .preview-content img {
      max-width: 100%;
      height: auto;
    }
    .preview-content blockquote {
      margin: 1em 0;
      padding: 1em;
      border-left: 4px solid #e5e7eb;
      background-color: #f8f9fa;
    }
    .preview-content pre {
      background-color: #f8f9fa;
      padding: 1em;
      border-radius: 0.5em;
      overflow-x: auto;
    }
    .preview-content code {
      font-family: monospace;
      background-color: #f8f9fa;
      padding: 0.2em 0.4em;
      border-radius: 0.25em;
    }
  </style>
</head>
<body class="flex h-screen bg-gradient-to-br from-slate-50 to-blue-50 font-sans">

  <div x-data="emailApp()" x-init="init()" class="flex w-full">
    <!-- Sidebar -->
    {% include "dashboard/common/sidebar.html" %}
      

    <!-- Основная область -->
    <main class="flex-1 relative overflow-auto md:ml-64">
      <!-- Ошибки -->
      <template x-if="error">
        <div class="absolute top-6 right-6 z-50 bg-red-50 border-l-4 border-red-400 p-4 rounded-2xl shadow-2xl backdrop-blur-sm animate-in slide-in-from-top-2">
          <div class="flex items-center">
            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
              <!-- AlertCircle icon -->
              <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4m0 4h.01"/></svg>
            </div>
            <p class="text-sm font-semibold text-red-800" x-text="error"></p>
            <button @click="error=null" class="ml-4 text-red-400 hover:text-red-600 p-1 rounded-full">
              ×
            </button>
          </div>
        </div>
      </template>

      <!-- Список шаблонов -->
      <section x-show="view==='list'" class="animate-in slide-in-from-left-5 duration-500 h-full overflow-auto p-8 bg-gradient-to-br from-gray-50 to-white">
        <div class="max-w-7xl mx-auto">
          <!-- Header -->
          <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-10">
            <div class="mb-6 lg:mb-0">
              <h2 class="text-4xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent mb-2">
                Шаблоны электронных писем
              </h2>
              <p class="text-gray-600 text-lg">Создавайте, редактируйте и управляйте своими прекрасными шаблонами электронных писемь</p>
            </div>
            <button @click="createNew()"class="group relative inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-[#2A72E5] text-white 
            font-semibold shadow-md transition-all duration-300 hover:bg-[#1E5BCC] hover:shadow-lg focus:outline-none">
              <!-- Plus icon -->
              <svg class="w-6 h-6 group-hover:rotate-180 transition-transform duration-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
              <span class="font-semibold text-lg">Создать новый шаблон</span>
            </button>
          </div>

          <!-- Search & Filter -->
          <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <div class="relative flex-1">
              <!-- Search icon -->
              <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
              <input type="text" placeholder="Поиск шаблонов..." x-model="search" class="w-full pl-12 pr-4 py-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 text-gray-700 shadow-sm" />
            </div>
            <div class="relative">
              <!-- Filter icon -->
              <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 4h18M6 12h12M10 20h4"/></svg>
              <select x-model="category" class="pl-12 pr-8 py-4 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 text-gray-700 shadow-sm appearance-none cursor-pointer">
                <template x-for="cat in ['all', ...new Set(templates.map(t=>t.category))]" :key="cat">
                  <option :value="cat" x-text="cat==='all'?'Категории':cat"></option>
                </template>
              </select>
            </div>
          </div>

          <!-- Loading -->
          <template x-if="loading">
            <div class="flex flex-col items-center justify-center py-20">
              <div class="relative">
                <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin"></div>
                <div class="absolute inset-0 w-16 h-16 border-4 border-transparent border-r-purple-500 rounded-full animate-spin animation-delay-75"></div>
              </div>
              <p class="mt-6 text-gray-600 font-medium">Загружаем ваши прекрасные шаблоны...</p>
            </div>
          </template>

          <!-- Grid of templates -->
          <div x-show="!loading && filtered.length" class="grid gap-8 md:grid-cols-2 xl:grid-cols-3">
            <template x-for="(tpl, i) in filtered" :key="tpl.id">
              <div @click="editTemplate(tpl)" class="group bg-white border border-gray-200 rounded-3xl overflow-hidden hover:shadow-2xl cursor-pointer transition-all duration-500 hover:scale-105 hover:border-blue-300" :style="`animation-delay:${100*i}ms`">
                <div class="relative h-48 bg-gradient-to-br from-gray-50 to-gray-100 overflow-hidden">
                  <div class="absolute inset-0 scale-50 origin-center transform hover:scale-[.55] transition-transform duration-300" x-html="tpl.content"></div>
                  <div class="absolute inset-0 bg-gradient-to-t from-white/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                  <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <div class="flex space-x-2">
                      <button @click.stop="duplicateTemplate(tpl)" class="p-2 bg-white/90 backdrop-blur-sm rounded-full shadow-lg hover:bg-white">
                        <!-- Copy icon -->
                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                      </button>
                      <div class="relative" x-data="{ open: false }">
                        <button @click.stop="open = !open" class="p-2 bg-white/90 backdrop-blur-sm rounded-full shadow-lg hover:bg-white">
                          <!-- MoreVertical icon -->
                          <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                        </button>
                        <!-- Dropdown menu -->
                        <div x-show="open" 
                             @click.away="open = false"
                             x-transition:enter="transition ease-out duration-100"
                             x-transition:enter-start="transform opacity-0 scale-95"
                             x-transition:enter-end="transform opacity-100 scale-100"
                             x-transition:leave="transition ease-in duration-75"
                             x-transition:leave-start="transform opacity-100 scale-100"
                             x-transition:leave-end="transform opacity-0 scale-95"
                             class="absolute right-0 mt-2 w-48 rounded-xl bg-white shadow-lg ring-1 ring-black ring-opacity-5 z-50">
                          <div class="py-1">
                            <button @click.stop="duplicateTemplate(tpl); open = false" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                              <span>Дублировать</span>
                            </button>
                            <button @click.stop="deleteTemplate(tpl); open = false" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center space-x-2">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                              <span>Удалить</span>
                            </button>
                            <button @click.stop="toggleDraft(tpl); open = false" class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                              <span x-text="tpl.is_draft ? 'Опубликовать' : 'В черновики'"></span>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="p-6">
                  <div class="flex items-start justify-between mb-3">
                    <h3 class="text-xl font-bold text-gray-800 group-hover:text-blue-600 transition-colors duration-300" x-text="tpl.name"></h3>
                    <span class="px-3 py-1 bg-gradient-to-r from-blue-100 to-purple-100 text-blue-700 text-xs font-semibold rounded-full" x-text="tpl.category"></span>
                  </div>
                  <p class="text-gray-600 text-sm mb-4 line-clamp-2 leading-relaxed" x-text="truncate(tpl.content, 120)"></p>
                  <div class="flex items-center justify-between text-xs text-gray-500">
                    <span x-text="`Обновлено: ${formatDate(tpl.lastModified)}`"></span>
                    <div class="flex items-center space-x-1">
                      <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                      <span>Готовый</span>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <!-- Нет шаблонов -->
          <template x-if="!loading && !filtered.length">
            <div class="text-center py-20">
              <div class="w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mx-auto mb-6">
                <!-- Search icon -->
                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
              </div>
              <h3 class="text-2xl font-bold text-gray-600 mb-2">Шаблоны не найдены</h3>
              <p class="text-gray-500 mb-8">Попробуйте изменить поиск или создайте новый шаблон.</p>
              <button @click="createNew()" class="bg-gradient-to-r from-[#2A72E5] to-[#5C9EFF] text-white px-6 py-3 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 font-medium tracking-wide"
              style="font-family: 'Inter', 'Roboto', sans-serif;">
                Создайте свой первый шаблон
              </button>
            </div>
          </template>
        </div>
      </section>

      <!-- Editor + Preview -->
      <section x-show="view==='editor'" class="animate-in slide-in-from-right-5 duration-500 h-full flex flex-col bg-gradient-to-br from-gray-50 to-white">

        <!-- Header -->
        <div class="bg-white/80 backdrop-blur-md border-b border-gray-200 p-6 shadow-sm">
          <div class="max-w-7xl mx-auto flex items-center justify-between mb-6">
            <button @click="view='list'; loadTemplates()" class="flex items-center space-x-3 text-gray-600 hover:text-gray-800 hover:bg-gray-100 px-4 py-2 rounded-xl transition">
              <!-- ArrowLeft icon -->
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg>
              <span class="font-semibold">Вернуться к шаблонам</span>
            </button>
            <div class="flex items-center space-x-6">
              <template x-if="saveStatus==='saving'">
                <div class="flex items-center space-x-2 text-blue-600">
                  <div class="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                  <span class="font-medium">Сохранение...</span>
                </div>
              </template>
              <template x-if="saveStatus==='saved'">
                <div class="flex items-center space-x-2 text-emerald-600">
                  <div class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>
                  </div>
                  <span class="font-medium">Все изменения сохранены</span>
                </div>
              </template>
              <template x-if="saveStatus==='error'">
                <div class="flex items-center space-x-2 text-red-600">
                  <span class="font-medium">Не удалось сохранить</span>
                </div>
              </template>
              <button 
                @click="saveNow()" 
                class="flex items-center space-x-2 px-6 py-3 rounded-lg transition-all duration-300 ease-in-out font-medium
                        bg-[#2A72E5] text-white hover:bg-[#1E5BCC] shadow-md hover:shadow-lg"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                    <path d="M17 21v-8H7v8"/>
                    <path d="M7 3v5h8"/>
                </svg>
                <span>Сохранить шаблон</span>
              </button>

            </div>
          </div>
          <input type="text" x-model="current.name" @input="onChange('name', current.name)" placeholder="Введите название шаблона..." class="w-full text-3xl font-bold border-none outline-none bg-transparent text-gray-800" />
        </div>

        <!-- Editor & Preview Container -->
        <div class="flex-1 flex overflow-hidden max-w-full mx-auto w-full p-6">
          <!-- Editor -->
          <div class="flex flex-col flex-1 min-w-0 mr-4 bg-white rounded-2xl shadow-sm overflow-hidden">
            <!-- Tabs -->
            <div class="flex space-x-2 border-b border-gray-200 p-4 bg-white">
              <!-- Visual Mode Button -->
              <button 
                @click="editMode='visual'" 
                :class="editMode === 'visual' 
                ? 'bg-[#2A72E5] text-white shadow-md scale-[1.02]' 
                : 'text-gray-600 hover:bg-[#F0F4FF] hover:text-[#2A72E5] hover:shadow-sm'"
                class="px-6 py-3 rounded-lg transition-all duration-300 ease-in-out flex items-center space-x-2 font-medium"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
                <span>Визуальный</span>
              </button>

              <!-- HTML Mode Button -->
              <button 
                @click="editMode='html'" 
                :class="editMode === 'html' 
                ? 'bg-gradient-to-r from-emerald-500 to-teal-600 text-white shadow-md scale-[1.02]' 
                : 'text-gray-600 hover:bg-[#F0F4FF] hover:text-teal-600 hover:shadow-sm'"
                class="px-6 py-3 rounded-lg transition-all duration-300 ease-in-out flex items-center space-x-2 font-medium"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M11 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-5"/>
                  <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                <span>HTML</span>
              </button>
            </div>

            <!-- Editing Area -->
            <div class="flex-1 min-h-0 overflow-auto">
              <template x-if="editMode==='html'">
                <textarea
                  x-model="current.content"
                  @input="onChange('content', current.content)"
                  class="w-full h-full min-h-0 resize-none focus:ring-4 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none font-mono text-sm p-4"
                  style="border:1px solid #e5e7eb; border-radius:.75rem;"
                ></textarea>
              </template>
              <template x-if="editMode==='visual'">
                <div class="flex flex-col h-full">
                  <!-- CKEditor Toolbar -->
                  <div id="toolbar-container" class="border-b border-gray-200"></div>
                  <!-- CKEditor Content -->
                  <div id="editor-container" class="flex-1 overflow-auto p-4 border border-gray-200 rounded-lg"></div>
                </div>
              </template>
            </div>
          </div>

          <!-- Splitter -->
          <div
            class="w-1 bg-gray-200 cursor-col-resize"
            @mousedown.prevent="startSplit($event)"
          ></div>

          <!-- Preview -->
          <div class="flex flex-col flex-1 min-w-0 ml-4 bg-white rounded-2xl shadow-sm overflow-hidden">
            <div class="flex items-center space-x-3 p-4 border-b border-gray-200 bg-white">
              <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              </div>
              <h3 class="text-xl font-bold text-gray-800">Живой просмотр</h3>
            </div>
            <div class="flex-1 min-h-0 overflow-auto p-4">
              <div class="preview-content bg-white rounded-2xl shadow-inner p-6 min-h-full border border-gray-100" x-html="current.content"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- FAB для мобильных -->
      <div class="fixed bottom-6 right-6 md:hidden">
        <button @click="createNew()" class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-2xl shadow-2xl hover:shadow-blue-500/40 transition transform hover:scale-110">
          <!-- Plus icon -->
          <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
        </button>
      </div>
    </main>
  </div>

  <script>
    // Глобальная переменная для хранения редактора
    let globalEditor = null;

    function emailApp() {
      return {
        view: 'list',
        loading: true,
        error: null,
        templates: [],
        current: {
          id: null,
          name: '',
          content: '',
          category: '',
          lastModified: null,
          is_draft: true
        },
        editMode: 'visual',
        saveStatus: 'saved',
        search: '',
        category: 'all',
        saveTimeout: null,
        editorReady: false,
        isAdmin: true,

        async init() {
          await this.loadTemplates();
          this.$watch('editMode', (value) => {
            if (value === 'visual') {
              setTimeout(() => {
                this.initEditor();
              }, 100);
            }
          });
        },

        async initEditor() {
          try {
            console.log('=== Editor Initialization Start ===');
            
            const editorContainer = document.querySelector('#editor-container');
            const toolbarContainer = document.querySelector('#toolbar-container');
            
            if (!editorContainer || !toolbarContainer) {
              console.error('Editor or toolbar container not found!');
              return;
            }

            if (!window.DecoupledEditor) {
              console.error('DecoupledEditor not found in window object!');
              await this.loadCKEditor();
              if (!window.DecoupledEditor) {
                throw new Error('Failed to load CKEditor');
              }
            }

            // Уничтожаем существующий редактор если он есть
            if (globalEditor) {
              console.log('Destroying existing editor...');
              await globalEditor.destroy();
              globalEditor = null;
            }

            // Очищаем контейнеры
            editorContainer.innerHTML = '';
            toolbarContainer.innerHTML = '';

            try {
              console.log('Creating new editor instance...');
              
              // Создаем новый экземпляр редактора
              globalEditor = await window.DecoupledEditor.create(editorContainer, {
                toolbar: {
                  items: [
                    'heading',
                    '|',
                    'fontSize',
                    'fontFamily',
                    'fontColor',
                    'fontBackgroundColor',
                    '|',
                    'bold',
                    'italic',
                    'underline',
                    'strikethrough',
                    'subscript',
                    'superscript',
                    '|',
                    'alignment',
                    '|',
                    'numberedList',
                    'bulletedList',
                    '|',
                    'outdent',
                    'indent',
                    '|',
                    'link',
                    'blockQuote',
                    'insertTable',
                    'mediaEmbed',
                    'imageUpload',
                    '|',
                    'horizontalLine',
                    'pageBreak',
                    '|',
                    'code',
                    'codeBlock',
                    '|',
                    'specialCharacters',
                    '|',
                    'sourceEditing',
                    '|',
                    'undo',
                    'redo',
                    '|',
                    'findAndReplace',
                    '|',
                    'removeFormat',
                    '|',
                    'highlight',
                    '|',
                    'textPartLanguage',
                    '|',
                    'restrictedEditing',
                    '|',
                    'tableProperties',
                    'tableCellProperties',
                    '|',
                    'toggleImageCaption',
                    'imageTextAlternative',
                    '|',
                    'insertTemplate',
                    '|',
                    'insertTable',
                    '|',
                    'tableColumn',
                    'tableRow',
                    'mergeTableCells',
                    '|',
                    'imageStyle:inline',
                    'imageStyle:block',
                    'imageStyle:side',
                    '|',
                    'linkImage',
                    '|',
                    'insertTable',
                    '|',
                    'tableProperties',
                    'tableCellProperties',
                    '|',
                    'toggleImageCaption',
                    'imageTextAlternative',
                    '|',
                    'insertTemplate'
                  ],
                  shouldNotGroupWhenFull: true
                },
                image: {
                  toolbar: [
                    'imageStyle:inline',
                    'imageStyle:block',
                    'imageStyle:side',
                    '|',
                    'toggleImageCaption',
                    'imageTextAlternative',
                    '|',
                    'linkImage'
                  ],
                  styles: [
                    'full',
                    'side',
                    'alignLeft',
                    'alignCenter',
                    'alignRight'
                  ]
                },
                table: {
                  contentToolbar: [
                    'tableColumn',
                    'tableRow',
                    'mergeTableCells',
                    'tableProperties',
                    'tableCellProperties'
                  ]
                },
                placeholder: 'Начните писать ваше письмо здесь...',
                language: 'ru'
              });

              // Перемещаем панель инструментов в нужное место
              toolbarContainer.appendChild(globalEditor.ui.view.toolbar.element);

              console.log('Editor instance created successfully');

              // Устанавливаем начальное содержимое
              if (this.current && this.current.content) {
                console.log('Setting initial content...');
                globalEditor.setData(this.current.content);
              }

              // Настраиваем обработку контента для превью
              globalEditor.model.document.on('change:data', () => {
                const data = globalEditor.getData();
                if (this.current) {
                  this.current.content = data;
                  // Обновляем превью с правильными стилями
                  const previewContainer = document.querySelector('.preview-content');
                  if (previewContainer) {
                    previewContainer.innerHTML = data;
                  }
                  this.autoSave();
                }
              });

              this.editorReady = true;
              console.log('Editor initialization completed successfully');
            } catch (error) {
              console.error('Error creating editor instance:', error);
              throw error;
            }
          } catch (error) {
            console.error('Editor initialization failed:', error);
            this.error = 'Ошибка инициализации редактора: ' + error.message;
          }
        },

        async loadCKEditor() {
          return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdn.ckeditor.com/ckeditor5/40.1.0/decoupled-document/ckeditor.js';
            script.onload = () => {
              console.log('CKEditor script loaded');
              resolve();
            };
            script.onerror = () => {
              console.error('Failed to load CKEditor script');
              reject(new Error('Failed to load CKEditor'));
            };
            document.head.appendChild(script);
          });
        },

        editTemplate(tpl) {
          this.current = JSON.parse(JSON.stringify(tpl));
          this.view = 'editor';
          this.editMode = 'visual';
          
          setTimeout(() => {
            this.initEditor();
          }, 100);
        },

        createNew() {
          const now = new Date();
          const formattedDate = now.toLocaleDateString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          }).replace(/\./g, '-');
          const formattedTime = now.toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit'
          }).replace(/:/g, '-');
          
          this.current = {
            id: null,
            name: `Шаблон от ${formattedDate} ${formattedTime}`,
            content: '<div style="padding:40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:16px;text-align:center;color:white;"><h1 style="margin:0 0 20px 0;font-size:32px;">✨ Начните создание</h1><p style="font-size:18px;opacity:0.9;margin:0;">Начните создавать ваш прекрасный шаблон письма здесь...</p></div>',
            lastModified: now.toISOString(),
            category: 'Custom',
            is_draft: true
          };
          this.view = 'editor';
          this.editMode = 'visual';
          
          setTimeout(() => {
            this.initEditor();
          }, 100);
        },

        onChange(field, value) {
          if (this.current) {
            this.current[field] = value;
            this.autoSave();
          }
        },

        autoSave() {
          this.saveStatus = 'saving';
          clearTimeout(this.saveTimeout);
          this.saveTimeout = setTimeout(() => this.saveNow(), 1200);
        },

        async saveNow() {
          if (!this.current) return;
          this.saveStatus = 'saving';
          try {
            let saved;
            if (this.current.id) {
              saved = await this.api.saveTemplate(this.current.id, {
                title: this.current.name,
                html_content: this.current.content,
                ck_content: this.current.content,
                plain_text_content: this.current.content.replace(/<[^>]*>/g, ''),
                is_draft: this.current.is_draft
              });
              this.templates = this.templates.map(t => t.id === saved.id ? saved : t);
            } else {
              saved = await this.api.createTemplate({
                title: this.current.name,
                html_content: this.current.content,
                ck_content: this.current.content,
                plain_text_content: this.current.content.replace(/<[^>]*>/g, ''),
                is_draft: this.current.is_draft
              });
              this.templates.push(saved);
              this.current.id = saved.id;
            }
            this.saveStatus = 'saved';
          } catch (err) {
            console.error(err);
            this.error = err.message || 'Ошибка при сохранении';
            this.saveStatus = 'error';
          }
        },

        formatDate(dt) {
          return new Date(dt).toLocaleDateString('ru-RU', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
        },

        truncate(html, n) {
          const txt = html.replace(/<[^>]*>/g, '');
          return txt.length > n ? txt.slice(0, n) + '…' : txt;
        },

        get filtered() {
          return this.templates
            .filter(t => this.category === 'all' || t.category === this.category)
            .filter(t =>
              t.name.toLowerCase().includes(this.search.toLowerCase()) ||
              t.content.toLowerCase().includes(this.search.toLowerCase())
            );
        },

        api: {
          async getTemplates() {
            const res = await fetch('/templates/api/templates/', { credentials: 'same-origin' });
            if (!res.ok) throw new Error('Не удалось загрузить шаблоны');
            return await res.json();
          },
          async createTemplate(body) {
            const res = await fetch('/templates/api/templates/', {
              method: 'POST',
              credentials: 'same-origin',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCSRFToken(),
              },
              body: JSON.stringify(body),
            });
            if (!res.ok) {
              const err = await res.json().catch(() => null);
              throw new Error(err?.detail || `Status ${res.status}`);
            }
            return await res.json();
          },
          async saveTemplate(id, body) {
            const res = await fetch(`/templates/api/templates/${id}/`, {
              method: 'PUT',
              credentials: 'same-origin',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCSRFToken(),
              },
              body: JSON.stringify(body),
            });
            if (!res.ok) throw new Error(`Status ${res.status}`);
            return await res.json();
          },
          getCSRFToken() {
            return document.cookie
              .split(';')
              .map(c => c.trim())
              .find(c => c.startsWith('csrftoken='))
              ?.split('=')[1] || '';
          },
          async deleteTemplate(id) {
            const res = await fetch(`/templates/api/templates/${id}/`, {
              method: 'DELETE',
              credentials: 'same-origin',
              headers: {
                'X-CSRFToken': this.getCSRFToken(),
              },
            });
            if (!res.ok) throw new Error(`Status ${res.status}`);
          }
        },

        async loadTemplates() {
          try {
            this.loading = true;
            const data = await this.api.getTemplates();
            this.templates = data.map(t => ({
              id: t.id,
              name: t.title,
              content: t.html_content,
              category: t.is_draft ? 'Черновики' : 'Опубликованные',
              lastModified: t.updated_at,
              is_draft: t.is_draft
            }));
          } catch (e) {
            this.error = e.message;
          } finally {
            this.loading = false;
          }
        },

        async duplicateTemplate(tpl) {
          try {
            const now = new Date();
            const formattedDate = now.toLocaleDateString('ru-RU', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            }).replace(/\./g, '-');
            const formattedTime = now.toLocaleTimeString('ru-RU', {
              hour: '2-digit',
              minute: '2-digit'
            }).replace(/:/g, '-');

            const duplicatedTemplate = {
              title: `${tpl.name} (Дубликат от ${formattedDate} ${formattedTime})`,
              html_content: tpl.content,
              ck_content: tpl.content,
              plain_text_content: tpl.content.replace(/<[^>]*>/g, ''),
              is_draft: true
            };

            const saved = await this.api.createTemplate(duplicatedTemplate);
            const newTemplate = {
              id: saved.id,
              name: saved.title,
              content: saved.html_content,
              category: saved.is_draft ? 'Черновики' : 'Опубликованные',
              lastModified: saved.updated_at,
              is_draft: saved.is_draft
            };
            
            // Находим индекс оригинального шаблона
            const originalIndex = this.templates.findIndex(t => t.id === tpl.id);
            // Вставляем дубликат сразу после оригинального шаблона
            this.templates.splice(originalIndex + 1, 0, newTemplate);
          } catch (err) {
            console.error(err);
            this.error = err.message || 'Ошибка при дублировании шаблона';
          }
        },

        async deleteTemplate(tpl) {
          if (!confirm('Вы уверены, что хотите удалить этот шаблон?')) return;
          
          try {
            await this.api.deleteTemplate(tpl.id);
            this.templates = this.templates.filter(t => t.id !== tpl.id);
          } catch (err) {
            console.error(err);
            this.error = err.message || 'Ошибка при удалении шаблона';
          }
        },

        async toggleDraft(tpl) {
          try {
            const updated = await this.api.saveTemplate(tpl.id, {
              title: tpl.name,
              html_content: tpl.content,
              ck_content: tpl.content,
              plain_text_content: tpl.content.replace(/<[^>]*>/g, ''),
              is_draft: !tpl.is_draft
            });
            
            this.templates = this.templates.map(t => 
              t.id === updated.id 
                ? {
                    ...t,
                    category: updated.is_draft ? 'Черновики' : 'Опубликованные',
                    is_draft: updated.is_draft
                  }
                : t
            );
          } catch (err) {
            console.error(err);
            this.error = err.message || 'Ошибка при изменении статуса шаблона';
          }
        }
      }
    }
  </script>

  <style>
    @keyframes animate-in { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .animate-in { animation:animate-in .5s ease-out; }
    .slide-in-from-left-5 { animation:slide-in-from-left .5s ease-out; }
    .slide-in-from-right-5 { animation:slide-in-from-right .5s ease-out; }
    .slide-in-from-top-2 { animation:slide-in-from-top .3s ease-out; }
    @keyframes slide-in-from-left { from{opacity:0;transform:translateX(-20px)} to{opacity:1;transform:translateX(0)} }
    @keyframes slide-in-from-right { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:translateX(0)} }
    @keyframes slide-in-from-top { from{opacity:0;transform:translateY(-20px)} to{opacity:1;transform:translateY(0)} }
    .animation-delay-75 { animation-delay:75ms; }
    .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  
    .cursor-col-resize {
      user-select: none;
      position: relative;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Преобразуем все <i data-lucide="..."> в SVG
      lucide.createIcons();
    });
  
    // Если у вас динамический контент (Alpine обновляет DOM),
    // повторно вызывайте createIcons после изменений:
    document.addEventListener('alpine:updated', () => {
      lucide.createIcons();
    });
  </script>
</body>
</html>
