# Настройка расширенных тарифов

## Обзор

Система расширенных тарифов поддерживает лимиты до 1 млн писем и подписчиков с динамическим поиском и интерполяцией цен.

## Компоненты

### 1. Модели
- `Plan` - тарифные планы
- `PlanType` - типы тарифов (Free, Subscribers, Letters)
- `PurchasedPlan` - купленные тарифы пользователей

### 2. API
- `/main/api/plans/` - получение тарифов для pricing.html
- `/billing/api/plans/` - управление тарифами
- `/billing/api/user-plan-info/` - информация о тарифе пользователя

### 3. Утилиты
- `get_user_plan_info()` - информация о тарифе
- `can_user_send_emails()` - проверка возможности отправки
- `find_plan_by_subscribers()` - поиск тарифа по подписчикам
- `find_plan_by_emails()` - поиск тарифа по письмам

## Развертывание

### 1. Применение миграций

```bash
python manage.py migrate billing
```

### 2. Создание бесплатного тарифа

```bash
python manage.py create_free_plan
```

### 3. Создание расширенных тарифов

```bash
# Создать все тарифы
python manage.py create_extended_plans

# Принудительно пересоздать тарифы
python manage.py create_extended_plans --force
```

### 4. Обновление счётчиков писем

```bash
python manage.py update_email_counts
```

### 5. Тестирование

```bash
python test_extended_plans.py
```

## Тарифы

### Бесплатный тариф
- **Подписчики**: 200
- **Письма**: неограниченно
- **Дневной лимит**: 50 писем
- **Цена**: 0₽

### Тарифы с лимитом писем

| Название | Письма | Цена | Дневной лимит |
|----------|--------|------|---------------|
| Письма 1,000 | 1,000 | 430₽ | 200 |
| Письма 2,000 | 2,000 | 800₽ | 400 |
| Письма 5,000 | 5,000 | 1,500₽ | 1,000 |
| Письма 10,000 | 10,000 | 2,500₽ | 2,000 |
| Письма 25,000 | 25,000 | 5,500₽ | 5,000 |
| Письма 50,000 | 50,000 | 9,999₽ | 10,000 |
| Письма 100,000 | 100,000 | 17,999₽ | 20,000 |
| Письма 250,000 | 250,000 | 39,999₽ | 50,000 |
| Письма 500,000 | 500,000 | 69,999₽ | 100,000 |
| Письма 1,000,000 | 1,000,000 | 129,999₽ | 200,000 |

### Тарифы с лимитом подписчиков

| Название | Подписчики | Цена | Дневной лимит |
|----------|------------|------|---------------|
| Подписчики 1,000 | 1,000 | 770₽ | 200 |
| Подписчики 2,000 | 2,000 | 1,500₽ | 400 |
| Подписчики 5,000 | 5,000 | 2,900₽ | 1,000 |
| Подписчики 10,000 | 10,000 | 4,900₽ | 2,000 |
| Подписчики 25,000 | 25,000 | 9,999₽ | 5,000 |
| Подписчики 50,000 | 50,000 | 17,999₽ | 10,000 |
| Подписчики 100,000 | 100,000 | 29,999₽ | 20,000 |
| Подписчики 250,000 | 250,000 | 54,999₽ | 50,000 |
| Подписчики 500,000 | 500,000 | 99,999₽ | 100,000 |
| Подписчики 1,000,000 | 1,000,000 | 179,999₽ | 200,000 |

## Функциональность

### 1. Динамический поиск тарифов

Система автоматически находит подходящий тариф на основе:
- Количества подписчиков
- Количества писем
- Ближайшего подходящего лимита

### 2. Интерполяция цен

Для значений между существующими тарифами цена рассчитывается интерполяцией:
```javascript
const ratio = (value - lowerValue) / (upperValue - lowerValue);
const price = lowerPrice + (upperPrice - lowerPrice) * ratio;
```

### 3. Проверка лимитов

Система проверяет:
- Остаток писем в тарифе "Letters"
- Срок действия тарифа "Subscribers"
- Дневные лимиты отправки

### 4. Автоматическое обновление

Счётчики писем обновляются автоматически при отправке через:
- Celery задачи
- API endpoints
- Management команды

## Интеграция с frontend

### 1. Загрузка тарифов

```javascript
async function loadPlans() {
  const response = await fetch('/main/api/plans/');
  const data = await response.json();
  plansData = data.plans;
  updateSliders();
}
```

### 2. Поиск тарифа

```javascript
function findPlanBySubscribers(count) {
  const plans = plansData.subscribers;
  // Логика поиска подходящего тарифа
}
```

### 3. Обновление слайдеров

```javascript
function updateSliders() {
  // Динамическое обновление min/max значений
  // Интерполяция цен
}
```

## Мониторинг

### 1. Логирование

Все операции логируются:
- Создание тарифов
- Покупка тарифов
- Отправка писем
- Превышение лимитов

### 2. Статистика

В админке доступна статистика:
- Популярность тарифов
- Использование лимитов
- Конверсия покупок

### 3. Уведомления

Система уведомляет о:
- Истечении тарифа
- Превышении лимитов
- Успешных покупках

## Безопасность

### 1. Валидация

- Проверка существования тарифа
- Валидация лимитов
- Проверка прав доступа

### 2. Аудит

- Логирование всех операций
- Отслеживание изменений
- История покупок

### 3. Ограничения

- Защита от превышения лимитов
- Проверка дневных лимитов
- Валидация данных

## Следующие шаги

После настройки расширенных тарифов:

1. **Интеграция CloudPayments** - подключение платежной системы
2. **Автопродление** - автоматическое продление тарифов
3. **Аналитика** - детальная статистика использования
4. **Уведомления** - email и push уведомления
5. **API** - публичное API для интеграций

## Поддержка

При возникновении проблем:

1. Проверьте логи Django
2. Запустите тестовый скрипт
3. Проверьте настройки в админке
4. Обратитесь к документации API 