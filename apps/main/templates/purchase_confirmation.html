<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Подтверждение покупки — vashsender</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://widget.cloudpayments.ru/bundles/cloudpayments.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f6f9fc; }
        .divider { border-bottom: 1px solid #e3e8ee; }
        .green-btn { background: #00b86b; }
        .green-btn:hover { background: #009e5c; }
        .checkbox:checked { accent-color: #00b86b; }
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="min-h-screen flex flex-col md:flex-row w-full px-4 md:px-32 py-8">
  <!-- Левая часть: Детали тарифа -->
  <div class="md:w-1/2 w-full bg-white flex flex-col justify-between border-b md:border-b-0 md:border-r border-gray-200 px-0 md:px-8 py-8 md:py-16">
    <div>
      <div class="flex items-center mb-10">
        <a href="/pricing/" class="mr-4 text-gray-400 hover:text-blue-600 transition">
          <i data-lucide="arrow-left" class="w-6 h-6"></i>
        </a>
        <div class="flex items-center">
          <div class="bg-blue-100 rounded-full p-2 mr-3">
            <i data-lucide="mail" class="w-7 h-7 text-blue-600"></i>
          </div>
          <span class="text-2xl font-bold text-gray-900">vashsender</span>
        </div>
      </div>
      <div class="mb-10">
        <div class="text-gray-500 text-sm mb-1">Подписка на тариф</div>
        <div class="flex items-end gap-2 mb-2">
          <span class="text-4xl font-extrabold text-gray-900">₽{{ plan.price|default:"0" }}</span>
          <span class="text-base text-gray-500 mb-1">раз в месяц</span>
        </div>
        <div class="text-xs text-gray-400 mb-6">Счет выставляется ежемесячно</div>
        <div class="divider mb-4"></div>
        <div class="flex justify-between text-gray-700 mb-2">
          <span>{{ plan.title|default:"Тариф" }}</span>
          <span>₽{{ plan.price|default:"0" }}</span>
        </div>
        <div class="flex justify-between text-gray-700 mb-2">
          <span>Подытог</span>
          <span>₽{{ plan.price|default:"0" }}</span>
        </div>
        <div class="flex justify-between text-gray-700 mb-2">
          <span>Налог</span>
          <span>₽0</span>
        </div>
        <div class="divider my-4"></div>
        <div class="flex justify-between text-lg font-bold">
          <span>Всего к оплате сегодня</span>
          <span>₽{{ plan.price|default:"0" }}</span>
        </div>
      </div>
      <div class="mt-10">
        <div class="text-lg font-semibold text-gray-900 mb-2">Подробнее о тарифе</div>
        <div class="text-gray-700 mb-2">{{ plan.description|default:"Описание тарифа отсутствует." }}</div>
        <ul class="text-gray-700 text-sm space-y-1 mb-2">
          {% if plan.subscribers > 0 %}
          <li>• До {{ plan.subscribers|floatformat:0 }} подписчиков</li>
          {% endif %}
          {% if plan.emails_per_month > 0 %}
          <li>• {{ plan.emails_per_month|floatformat:0 }} писем в месяц</li>
          {% elif plan.emails_per_month == 0 and plan.plan_type.name == 'Subscribers' %}
          <li>• Неограниченные письма</li>
          {% endif %}
          {% if plan.max_emails_per_day > 0 %}
          <li>• До {{ plan.max_emails_per_day }} писем в день</li>
          {% endif %}
          <li>• Продвинутые шаблоны</li>
          <li>• Детальная аналитика</li>
          {% if plan.plan_type.name == 'Subscribers' %}
          <li>• A/B тестирование</li>
          <li>• API доступ</li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
  <!-- Правая часть: Оформление -->
  <div class="md:w-1/2 w-full flex flex-col justify-between bg-white px-0 md:px-8 py-8 md:py-16">
    <form x-data="purchaseApp()" @submit.prevent="processPurchase()" class="flex flex-col h-full" 
          data-plan-id="{{ plan.id|default:0 }}" 
          data-plan-title="{{ plan.title|escapejs }}" 
          data-plan-price="{{ plan.price|default:0 }}" 
          data-user-email="{{ request.user.email|escapejs }}">
      <div>
        <div class="mb-8">
          <div class="text-gray-900 font-semibold mb-1">Контактные данные</div>
          <div class="bg-gray-100 rounded-lg px-4 py-3 text-gray-900 font-semibold">{{ request.user.email }}</div>
        </div>
        <div class="mb-8">
          <div class="text-gray-900 font-semibold mb-1">Информация о тарифе</div>
          <div class="bg-gray-100 rounded-lg px-4 py-3 text-gray-900">
            <div class="font-medium">{{ plan.title|default:"Тариф" }}</div>
            <div class="text-xs text-gray-500">
              {% if plan.subscribers > 0 %}До {{ plan.subscribers|floatformat:0 }} подписчиков{% endif %}
              {% if plan.emails_per_month > 0 %} • {{ plan.emails_per_month|floatformat:0 }} писем/мес{% endif %}
              {% if plan.max_emails_per_day > 0 %} • до {{ plan.max_emails_per_day }} в день{% endif %}
            </div>
          </div>
        </div>
        <div class="mb-8">
          <div class="flex items-start mb-2">
            <input type="checkbox" id="agree" x-model="agreedToTerms" class="checkbox mt-1 h-4 w-4 text-green-600 border-gray-300 rounded">
            <label for="agree" class="ml-2 text-sm text-gray-700">
              Я согласен с <a href="#" class="text-blue-600 hover:underline">условиями использования</a> и <a href="#" class="text-blue-600 hover:underline">политикой конфиденциальности</a>
            </label>
          </div>
        </div>
      </div>
      <div class="mt-auto">
        <button type="submit" :disabled="!agreedToTerms || isProcessing" @click="console.log('Button clicked')"
                class="w-full green-btn text-white font-bold py-3 px-6 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed text-lg mb-3">
          <span x-show="!isProcessing">
            <i data-lucide="credit-card" class="w-5 h-5 inline mr-2"></i>
            Подписаться
          </span>
          <span x-show="isProcessing" class="flex items-center">
            <div class="loading-spinner mr-2"></div>
            Обработка...
          </span>
        </button>
        <div class="text-center text-xs text-gray-500 mt-2">
          Оплата производится на стороне <span class="font-semibold text-blue-700">CloudPayments</span>
          {% if cloudpayments_test_mode %}
          <br><span class="text-orange-600 font-semibold">ТЕСТОВЫЙ РЕЖИМ</span>
          {% endif %}
        </div>
      </div>
      {% csrf_token %}
    </form>
  </div>
</div>

<script>
  // Ждем загрузки всех скриптов
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');
    console.log('Alpine available:', typeof Alpine !== 'undefined');
    console.log('CloudPayments available:', typeof cp !== 'undefined');
    console.log('jQuery available:', typeof $ !== 'undefined');
    
    // Инициализируем иконки
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
    
    // Проверяем, что Alpine.js загружен
    if (typeof Alpine === 'undefined') {
      console.error('Alpine.js не загружен!');
      return;
    }
    
    // Глобальная функция для Alpine.js
    console.log('Defining purchaseApp function...');
    window.purchaseApp = function() {
      console.log('purchaseApp function called');
      return {
        agreedToTerms: false,
        isProcessing: false,
        
        init() {
          console.log('Alpine init called');
          // Получаем данные из data-атрибутов формы
          var form = this.$el;
          console.log('Form element:', form);
          console.log('Form dataset:', form.dataset);
          this.planData = {
            id: parseInt(form.dataset.planId) || 0,
            title: form.dataset.planTitle || 'Тариф',
            price: parseFloat(form.dataset.planPrice) || 0,
            userEmail: form.dataset.userEmail || 'user@example.com'
          };
          console.log('Plan data loaded:', this.planData);
        },
        
        processPurchase() {
          console.log('processPurchase called');
          console.log('agreedToTerms:', this.agreedToTerms);
          if (!this.agreedToTerms) {
            alert('Пожалуйста, согласитесь с условиями использования');
            return;
          }
          
          this.isProcessing = true;
          
          try {
            // Проверяем, что CloudPayments загружен
            if (typeof cp === 'undefined') {
              throw new Error('CloudPayments не загружен');
            }
            
            // Проверяем public_id
            var publicId = '{{ cloudpayments_public_id }}';
            if (!publicId) {
              throw new Error('Public ID CloudPayments не настроен');
            }
            
            // Создаем виджет CloudPayments с отключенными дополнительными методами оплаты
            var payments = new cp.CloudPayments({
              yandexPaySupport: false,
              applePaySupport: false,
              googlePaySupport: false,
              masterPassSupport: false,
              tinkoffInstallmentSupport: false
            });
            
            // Обработчик завершения оплаты
            payments.oncomplete = (result) => {
              console.log('Payment completed:', result);
            };
            
            // Формируем чек для фискализации
            var receipt = {
              Items: [{
                label: this.planData.title,
                price: this.planData.price,
                quantity: 1.00,
                amount: this.planData.price,
                vat: 20,
                method: 0,
                object: 0
              }],
              taxationSystem: 0,
              email: this.planData.userEmail,
              phone: '',
              isBso: false,
              amounts: {
                electronic: this.planData.price,
                advancePayment: 0.00,
                credit: 0.00,
                provision: 0.00
              }
            };

            // Данные для рекуррентных платежей
            var data = {
              CloudPayments: {
                CustomerReceipt: receipt,
                recurrent: {
                  interval: 'Month',
                  period: 1,
                  customerReceipt: receipt
                }
              }
            };

            var self = this;
            
            // Запускаем оплату с Promise
            payments.pay("charge", {
              publicId: publicId,
              accountId: this.planData.userEmail,
              description: 'Подписка на тариф ' + this.planData.title + ' - vashsender',
              amount: this.planData.price,
              currency: 'RUB',
              invoiceId: 'PLAN-' + this.planData.id + '-' + Date.now(),
              data: data
            }).then((result) => {
              // Успешная оплата
              console.log('Payment successful:', result);
              // Структура result: {type: 'payment', data: {...}, status: 'success'}
              self.activatePlan(result.data || result);
            }).catch((error) => {
              // Ошибка оплаты
              console.error('Payment failed:', error);
              alert('Оплата не прошла: ' + (error.message || 'Неизвестная ошибка'));
              self.isProcessing = false;
            });
            
          } catch (error) {
            console.error('Error processing purchase:', error);
            alert('Произошла ошибка при обработке покупки: ' + error.message);
            this.isProcessing = false;
          }
        },
        
        activatePlan(paymentResult) {
          var self = this;
          
          $.ajax({
            url: '/billing/activate-payment/',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            data: JSON.stringify({
              plan_id: this.planData.id,
              payment_data: paymentResult
            }),
            success: function(result) {
              if (result.success) {
                window.location.href = '/purchase/success/?plan_id=' + self.planData.id + '&transaction_id=' + (paymentResult.invoiceId || paymentResult.TransactionId);
              } else {
                alert('Ошибка активации тарифа: ' + result.error);
                self.isProcessing = false;
              }
            },
            error: function(xhr, status, error) {
              console.error('Error activating plan:', error);
              console.error('Response:', xhr.responseText);
              alert('Ошибка активации тарифа. Обратитесь в поддержку.');
              self.isProcessing = false;
            }
          });
        }
      }
    }
  });
</script>
</body>
</html> 