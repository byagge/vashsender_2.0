<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Рассылки - vashsender</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <!-- Lucide Icons CDN -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    [x-cloak] { display: none; }
    .chart-container { height: 256px; }
    
    /* Email preview styles */
    .email-preview {
      max-width: 100%;
      overflow-x: auto;
    }
    
    .email-preview img {
      max-width: 100%;
      height: auto;
    }
    
    .email-preview table {
      border-collapse: collapse;
      width: 100%;
    }
    
    .email-preview td, .email-preview th {
      border: 1px solid #ddd;
      padding: 8px;
    }
  </style>
</head>
<body x-data="sentCampaigns()" x-init="init()">
  {% include "dashboard/common/sidebar.html" %}
  <div class="main-content md:ml-64">
    <!-- Main Container -->
    <div class="flex h-screen bg-gray-50" x-show="filteredCampaigns().length > 0 || searchTerm !== '' || statusFilter !== 'All'">
      <!-- Main Content -->
      <div class="flex-1 overflow-auto">
        <div class="p-8">
          <!-- Header -->
          <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Отправленные рассылки</h1>
            <p class="text-gray-600">Отслеживайте и анализируйте эффективность ваших email-рассылок</p>
          </div>

          <!-- Controls -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <div class="flex flex-wrap items-center gap-4">
              <!-- Search -->
              <div class="relative flex-1 min-w-64">
                <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                <input
                  type="text"
                  placeholder="Поиск рассылок..."
                  x-model="searchTerm"
                  class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>

              <!-- Filters -->
              <div class="flex items-center gap-3">
                <select
                  x-model="statusFilter"
                  class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="All">Все статусы</option>
                  <option value="draft">Черновик</option>
                  <option value="sending">Отправляется</option>
                  <option value="completed">Завершена</option>
                </select>

                <select
                  x-model="senderFilter"
                  class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="All">Все отправители</option>
                  <template x-for="sender in uniqueSenders()" :key="sender">
                    <option :value="sender" x-text="sender"></option>
                  </template>
                </select>

                <!-- Export controls -->
                <div class="flex items-center gap-2">
                  <button @click="showExportModal = true" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-2.5 rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all duration-200 flex items-center gap-2 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 font-medium">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Экспорт
                  </button>
                </div>

                <a href="/campaigns/new/" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-4 py-2.5 rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-200 flex items-center gap-2 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 font-medium">
                  <i data-lucide="plus" class="w-4 h-4"></i>
                  Новая рассылка
                </a>
              </div>
            </div>
          </div>

          <!-- Campaigns List -->
          <div class="space-y-4">
            <template x-for="campaign in paginatedCampaigns()" :key="campaign.id">
              <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-6">
                  <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-4">
                      <h3 class="text-lg font-semibold text-gray-900" x-text="campaign.name"></h3>
                      <span :class="'inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium border ' + getStatusColor(campaign.status)">
                        <span x-show="campaign.status === 'sent'"><i data-lucide="check-circle" class="w-4 h-4"></i></span>
                        <span x-show="campaign.status === 'draft'"><i data-lucide="file-text" class="w-4 h-4"></i></span>
                        <span x-show="campaign.status === 'sending'"><i data-lucide="send" class="w-4 h-4"></i></span>
                        <span x-show="campaign.status === 'pending'"><i data-lucide="clock" class="w-4 h-4"></i></span>
                        <span x-show="campaign.status === 'approved'"><i data-lucide="check-square" class="w-4 h-4"></i></span>
                        <span x-show="campaign.status === 'rejected'"><i data-lucide="x-circle" class="w-4 h-4"></i></span>
                        <span x-show="campaign.status === 'failed'"><i data-lucide="alert-triangle" class="w-4 h-4"></i></span>
                        <span x-text="campaign.status_display"></span>
                      </span>
                    </div>
                    <button
                      @click="toggleRowExpansion(campaign.id)"
                      class="text-gray-400 hover:text-gray-600 transition-colors"
                    >
                      <i x-show="!expandedRows.has(campaign.id)" data-lucide="chevron-down" class="w-5 h-5"></i>
                      <i x-show="expandedRows.has(campaign.id)" data-lucide="chevron-up" class="w-5 h-5"></i>
                    </button>
                  </div>

                  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-4">
                    <div>
                      <p class="text-sm text-gray-500 mb-1">Название</p>
                      <p class="text-sm font-medium text-gray-900" x-text="campaign.name || 'Без названия'"></p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500 mb-1">Дата создания</p>
                      <p class="text-sm font-medium text-gray-900 flex items-center gap-1">
                        <i data-lucide="calendar" class="w-4 h-4"></i>
                        <span x-text="formatDate(campaign.created_at)"></span>
                      </p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500 mb-1">Отправитель</p>
                      <p class="text-sm font-medium text-gray-900">
                        <template x-if="campaign.sender_name || campaign.sender_email">
                          <span>
                            <span x-text="campaign.sender_name"></span>
                            <template x-if="campaign.sender_email">
                              <span> (<span x-text="campaign.sender_email.email"></span>)</span>
                            </template>
                          </span>
                        </template>
                        <template x-if="!campaign.sender_name && !campaign.sender_email">
                          <span class="text-gray-500">Не указан</span>
                        </template>
                      </p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500 mb-1">Списки контактов</p>
                      <p class="text-sm font-medium text-gray-900 flex items-center gap-1">
                        <i data-lucide="users" class="w-4 h-4"></i>
                        <span x-text="getContactListsDisplay(campaign)"></span>
                      </p>
                    </div>
                  </div>

                  <div x-show="campaign.status === 'sent' || campaign.status === 'failed'" class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                    <div class="bg-gray-50 rounded-lg p-3">
                      <p class="text-xs text-gray-500 mb-1">Отправлено писем</p>
                      <p class="text-xl font-bold text-gray-900 flex items-center gap-1">
                        <i data-lucide="mail" class="w-4 h-4"></i>
                        <span x-text="campaign.emails_sent.toLocaleString()"></span>
                      </p>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-3">
                      <p class="text-xs text-gray-500 mb-1">Доставлено</p>
                      <p class="text-xl font-bold text-purple-600 flex items-center gap-1">
                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                        <span x-text="campaign.delivered_emails.toLocaleString()"></span>
                      </p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-3">
                      <p class="text-xs text-gray-500 mb-1">Открытия</p>
                      <p class="text-xl font-bold text-green-600 flex items-center gap-2">
                        <i data-lucide="eye" class="w-4 h-4"></i>
                        <span x-text="campaign.open_rate.toFixed(1) + '%'"></span>
                        <span class="text-gray-500 text-sm" x-text="'(' + (campaign.opens_count || 0).toLocaleString() + ')'"></span>
                      </p>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-3">
                      <p class="text-xs text-gray-500 mb-1">Клики</p>
                      <p class="text-xl font-bold text-blue-600 flex items-center gap-2">
                        <i data-lucide="mouse-pointer" class="w-4 h-4"></i>
                        <span x-text="campaign.click_rate.toFixed(1) + '%'"></span>
                        <span class="text-gray-500 text-sm" x-text="'(' + (campaign.clicks_count || 0).toLocaleString() + ')'"></span>
                      </p>
                    </div>
                    <div class="bg-red-50 rounded-lg p-3">
                      <p class="text-xs text-gray-500 mb-1">Отписались</p>
                      <p class="text-xl font-bold text-red-600 flex items-center gap-2">
                        <i data-lucide="user-x" class="w-4 h-4"></i>
                        <span x-text="(campaign.unsubscribed_count || 0).toLocaleString()"></span>
                      </p>
                    </div>
                  </div>

                  <!-- Expanded Content -->
                  <div x-show="expandedRows.has(campaign.id)" class="border-t border-gray-200 pt-4 mt-4" x-cloak>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      <div>
                        <h4 class="font-medium text-gray-900 mb-2">Детали рассылки</h4>
                        <div class="space-y-2 text-sm">
                          <p><span class="text-gray-500">Тема:</span> <span x-text="campaign.subject || 'Без темы'"></span></p>
                          <p><span class="text-gray-500">Ответ на:</span> <span x-text="campaign.sender_email_detail?.reply_to || 'Не указан'"></span></p>
                          <p><span class="text-gray-500">ID рассылки:</span> #<span x-text="campaign.id"></span></p>
                          <p><span class="text-gray-500">Запланировано на:</span> <span x-text="formatDate(campaign.scheduled_at)"></span></p>
                        </div>
                      </div>
                      <div>
                        <h4 class="font-medium text-gray-900 mb-2">Статистика по спискам</h4>
                        <div class="space-y-2 text-sm">
                          <template x-if="campaign.contact_lists_detail && campaign.contact_lists_detail.length > 0">
                            <template x-for="list in campaign.contact_lists_detail" :key="list.id">
                              <div class="flex justify-between">
                                <span class="text-gray-500" x-text="list.name + ':'"></span>
                                <span class="font-medium" x-text="(list.contacts_count || 0) + ' контактов'"></span>
                              </div>
                            </template>
                          </template>
                          <template x-if="!campaign.contact_lists_detail || campaign.contact_lists_detail.length === 0">
                            <p class="text-gray-500">Нет списков контактов</p>
                          </template>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Actions -->
                  <div class="flex items-center gap-3 pt-4 border-t border-gray-200">
                    <button @click="showStats(campaign)" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                      <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                      Статистика
                    </button>
                    <button @click="showPreview(campaign)" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-green-600 hover:bg-green-50 rounded-lg transition-colors">
                      <i data-lucide="eye" class="w-4 h-4"></i>
                      Просмотр
                    </button>
                    <template x-if="campaign.status === 'failed'">
                      <button 
                        @click="retryCampaign(campaign)"
                        class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-orange-600 hover:bg-orange-50 rounded-lg transition-colors"
                        :disabled="isRetrying"
                      >
                        <i data-lucide="refresh-cw" class="w-4 h-4" :class="{'animate-spin': isRetrying}"></i>
                        <span x-text="isRetrying ? 'Повторная отправка...' : 'Повторить попытку'"></span>
                      </button>
                    </template>
                    <button @click="showDeleteConfirm = campaign.id" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                      <i data-lucide="trash-2" class="w-4 h-4"></i>
                      Удалить
                    </button>
                    <template x-if="campaign.status === 'draft'">
                      <a :href="'/campaigns/' + campaign.id + '/'" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">
                        <i data-lucide="edit" class="w-4 h-4"></i>
                        Редактировать
                      </a>
                    </template>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <!-- Pagination -->
          <div x-show="totalPages() > 1" class="flex items-center justify-between mt-8">
            <p class="text-sm text-gray-700">
              Показано <span x-text="(currentPage - 1) * itemsPerPage + 1"></span> - 
              <span x-text="Math.min(currentPage * itemsPerPage, count)"></span> из 
              <span x-text="count"></span> рассылок
            </p>
            <div class="flex items-center gap-2">
              <!-- Previous button -->
              <button
                @click="goToPage(currentPage - 1)"
                :disabled="currentPage === 1"
                class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed border border-gray-300 rounded-lg hover:bg-gray-50 disabled:hover:bg-transparent"
              >
                Назад
              </button>
              
              <!-- First page -->
              <template x-if="currentPage > 3">
                <button
                  @click="goToPage(1)"
                  class="px-3 py-2 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 border border-gray-300"
                  x-text="1"
                ></button>
              </template>
              
              <!-- Ellipsis after first page -->
              <template x-if="currentPage > 4">
                <span class="px-2 text-gray-500">...</span>
              </template>
              
              <!-- Page numbers around current page -->
              <template x-for="page in getVisiblePages()" :key="page">
                <button
                  @click="goToPage(page)"
                  :class="currentPage === page ? 'px-3 py-2 text-sm font-medium rounded-lg bg-blue-600 text-white border border-blue-600' : 'px-3 py-2 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 border border-gray-300'"
                  x-text="page"
                ></button>
              </template>
              
              <!-- Ellipsis before last page -->
              <template x-if="currentPage < totalPages() - 3">
                <span class="px-2 text-gray-500">...</span>
              </template>
              
              <!-- Last page -->
              <template x-if="currentPage < totalPages() - 2">
                <button
                  @click="goToPage(totalPages())"
                  class="px-3 py-2 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 border border-gray-300"
                  x-text="totalPages()"
                ></button>
              </template>
              
              <!-- Next button -->
              <button
                @click="goToPage(currentPage + 1)"
                :disabled="currentPage === totalPages()"
                class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed border border-gray-300 rounded-lg hover:bg-gray-50 disabled:hover:bg-transparent"
              >
                Вперед
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div
      class="flex h-screen bg-gray-50"
      x-show="filteredCampaigns().length === 0 && searchTerm === '' && statusFilter === 'All'"
      x-cloak
    >
      <!-- Empty State Content -->
      <div class="flex-1 flex items-center justify-center">
        <div class="text-center">
          <div class="mx-auto w-32 h-32 bg-gray-100 rounded-full flex items-center justify-center mb-8">
            <i data-lucide="mail" class="w-16 h-16 text-gray-400"></i>
          </div>
          <h2 class="text-2xl font-semibold text-gray-900 mb-4">
            У вас пока нет отправленных рассылок
          </h2>
          <p class="text-gray-500 mb-8 max-w-md">
            Создайте свою первую email-рассылку, чтобы связаться с аудиторией и отслеживать результаты.
          </p>
          <a href="/campaigns/new/" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-8 py-4 rounded-xl font-medium hover:from-blue-700 hover:to-blue-800 transition-all duration-200 flex items-center gap-3 mx-auto shadow-lg hover:shadow-xl transform hover:-translate-y-1">
            <i data-lucide="plus" class="w-5 h-5"></i>
            Создать первую рассылку
          </a>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="showDeleteConfirm" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4">Удалить рассылку</h3>
        <p class="text-gray-600 mb-6">Вы уверены, что хотите удалить эту рассылку? Это действие не может быть отменено.</p>
        <div class="flex space-x-3">
          <button @click="showDeleteConfirm = null" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Отмена</button>
          <button @click="deleteCampaign()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Удалить</button>
        </div>
      </div>
    </div>

    <!-- Stats Modal -->
    <div x-show="showStatsModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 w-full max-w-2xl">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-semibold" x-text="'Статистика: ' + (selectedCampaign?.name || '')"></h3>
          <button @click="showStatsModal = false" class="text-gray-400 hover:text-gray-600">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        
        <div class="grid grid-cols-2 gap-6 mb-6">
          <div class="bg-gray-50 rounded-lg p-4">
            <p class="text-sm text-gray-500 mb-1">Отправлено писем</p>
            <p class="text-xl font-bold text-gray-900 flex items-center gap-1">
              <i data-lucide="mail" class="w-4 h-4"></i>
              <span x-text="selectedCampaign?.emails_sent.toLocaleString()"></span>
            </p>
          </div>
          <div class="bg-purple-50 rounded-lg p-4">
            <p class="text-sm text-gray-500 mb-1">Доставлено</p>
            <p class="text-xl font-bold text-purple-600 flex items-center gap-1">
              <i data-lucide="check-circle" class="w-4 h-4"></i>
              <span x-text="selectedCampaign?.delivered_emails.toLocaleString()"></span>
            </p>
          </div>
          <div class="bg-green-50 rounded-lg p-4">
            <p class="text-sm text-gray-500 mb-1">Открытия</p>
            <p class="text-xl font-bold text-green-600 flex items-center gap-2">
              <i data-lucide="eye" class="w-4 h-4"></i>
              <span x-text="selectedCampaign?.open_rate.toFixed(1) + '%'"></span>
              <span class="text-gray-500 text-sm" x-text="'(' + (selectedCampaign?.opens_count || 0).toLocaleString() + ')'"></span>
            </p>
          </div>
          <div class="bg-blue-50 rounded-lg p-4">
            <p class="text-sm text-gray-500 mb-1">Клики</p>
            <p class="text-xl font-bold text-blue-600 flex items-center gap-2">
              <i data-lucide="mouse-pointer" class="w-4 h-4"></i>
              <span x-text="selectedCampaign?.click_rate.toFixed(1) + '%'"></span>
              <span class="text-gray-500 text-sm" x-text="'(' + (selectedCampaign?.clicks_count || 0).toLocaleString() + ')'"></span>
            </p>
          </div>
          <div class="bg-red-50 rounded-lg p-4">
            <p class="text-sm text-gray-500 mb-1">Отписались</p>
            <p class="text-xl font-bold text-red-600 flex items-center gap-2">
              <i data-lucide="user-x" class="w-4 h-4"></i>
              <span x-text="(selectedCampaign?.unsubscribed_count || 0).toLocaleString()"></span>
            </p>
          </div>
        </div>

        <div class="space-y-4">
          <div>
            <h4 class="font-medium text-gray-900 mb-2">Детали рассылки</h4>
            <div class="space-y-2 text-sm">
              <p><span class="text-gray-500">Тема:</span> <span x-text="selectedCampaign?.subject || 'Без темы'"></span></p>
              <p><span class="text-gray-500">Отправитель:</span> <span x-text="(selectedCampaign?.sender_name || '') + ' (' + (selectedCampaign?.sender_email?.email || '') + ')'"></span></p>
              <p><span class="text-gray-500">Дата создания:</span> <span x-text="formatDate(selectedCampaign?.created_at)"></span></p>
              <p><span class="text-gray-500">Дата отправки:</span> <span x-text="formatDate(selectedCampaign?.sent_at)"></span></p>
            </div>
          </div>

          <div>
            <h4 class="font-medium text-gray-900 mb-2">Статистика по спискам</h4>
            <div class="space-y-2 text-sm">
              <template x-if="selectedCampaign?.contact_lists_detail && selectedCampaign?.contact_lists_detail.length > 0">
                <template x-for="list in selectedCampaign.contact_lists_detail" :key="list.id">
                  <div class="flex justify-between">
                    <span class="text-gray-500" x-text="list.name + ':'"></span>
                    <span class="font-medium" x-text="(list.contacts_count || 0) + ' контактов'"></span>
                  </div>
                </template>
              </template>
              <template x-if="!selectedCampaign?.contact_lists_detail || selectedCampaign?.contact_lists_detail.length === 0">
                <p class="text-gray-500">Нет списков контактов</p>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Preview Modal -->
    <div x-show="showPreviewModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden">
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
          <h3 class="text-lg font-semibold" x-text="'Просмотр: ' + (selectedCampaign?.name || '')"></h3>
          <button @click="showPreviewModal = false" class="text-gray-400 hover:text-gray-600">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
          <!-- Email Header Info -->
          <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <p class="text-gray-500 mb-1">От:</p>
                <p class="font-medium" x-text="(selectedCampaign?.sender_name || '') + ' <' + (selectedCampaign?.sender_email?.email || '') + '>'"></p>
              </div>
              <div>
                <p class="text-gray-500 mb-1">Тема:</p>
                <p class="font-medium" x-text="selectedCampaign?.subject || 'Без темы'"></p>
              </div>
              <div>
                <p class="text-gray-500 mb-1">Дата отправки:</p>
                <p class="font-medium" x-text="formatDate(selectedCampaign?.sent_at)"></p>
              </div>
              <div>
                <p class="text-gray-500 mb-1">Ответ на:</p>
                <p class="font-medium" x-text="selectedCampaign?.sender_email_detail?.reply_to || 'Не указан'"></p>
              </div>
            </div>
          </div>

          <!-- Email Content -->
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <div class="bg-white p-6">
              <!-- Приоритет 1: HTML содержимое из template_detail -->
              <template x-if="selectedCampaign?.template_detail?.html_content">
                <div x-html="selectedCampaign.template_detail.html_content" class="email-preview"></div>
              </template>
              
              <!-- Приоритет 2: Текстовое содержимое из template_detail -->
              <template x-if="!selectedCampaign?.template_detail?.html_content && selectedCampaign?.template_detail?.plain_text_content">
                <div class="email-preview">
                  <pre x-text="selectedCampaign.template_detail.plain_text_content" class="whitespace-pre-wrap font-sans"></pre>
                </div>
              </template>
              
              <!-- Приоритет 3: HTML содержимое из template -->
              <template x-if="!selectedCampaign?.template_detail?.html_content && !selectedCampaign?.template_detail?.plain_text_content && selectedCampaign?.template?.html_content">
                <div x-html="selectedCampaign.template.html_content" class="email-preview"></div>
              </template>
              
              <!-- Приоритет 4: Текстовое содержимое из template -->
              <template x-if="!selectedCampaign?.template_detail?.html_content && !selectedCampaign?.template_detail?.plain_text_content && !selectedCampaign?.template?.html_content && selectedCampaign?.template?.plain_text_content">
                <div class="email-preview">
                  <pre x-text="selectedCampaign.template.plain_text_content" class="whitespace-pre-wrap font-sans"></pre>
                </div>
              </template>
              
              <!-- Приоритет 5: Поле content из кампании -->
              <template x-if="!selectedCampaign?.template_detail?.html_content && !selectedCampaign?.template_detail?.plain_text_content && !selectedCampaign?.template?.html_content && !selectedCampaign?.template?.plain_text_content && selectedCampaign?.content">
                <div class="email-preview">
                  <div x-html="selectedCampaign.content"></div>
                </div>
              </template>
              
              <!-- Fallback: ничего не найдено -->
              <template x-if="!selectedCampaign?.template_detail?.html_content && !selectedCampaign?.template_detail?.plain_text_content && !selectedCampaign?.template?.html_content && !selectedCampaign?.template?.plain_text_content && !selectedCampaign?.content">
                <div class="text-center py-12 text-gray-500">
                  <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                  <p class="text-lg font-medium mb-2">Содержимое письма недоступно для просмотра</p>
                  <p class="text-sm">Возможные причины:</p>
                  <ul class="text-sm mt-2 space-y-1">
                    <li>• Шаблон письма был удален</li>
                    <li>• Шаблон не был привязан к рассылке</li>
                    <li>• Ошибка при загрузке данных шаблона</li>
                  </ul>
                  <p class="text-sm mt-4">Template ID: <span class="font-mono bg-gray-100 px-2 py-1 rounded" x-text="selectedCampaign?.template?.id || selectedCampaign?.template_detail?.id || 'Не указан'"></span></p>
                </div>
              </template>
            </div>
          </div>

          <!-- Email Footer -->
          <div class="mt-6 text-center text-sm text-gray-500">
            <p>Это предварительный просмотр письма, которое было отправлено в рамках рассылки</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Export Modal -->
    <div x-show="showExportModal" x-cloak class="fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
      <div class="relative mx-auto mt-20 w-full max-w-2xl px-4">
        <div class="bg-white rounded-2xl shadow-2xl border border-gray-100 overflow-hidden">
          <div class="px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="h-10 w-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                <i data-lucide="download" class="w-5 h-5"></i>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">Экспорт отчетов</h3>
                <p class="text-sm text-gray-500">Выберите формат и набор рассылок для выгрузки</p>
              </div>
            </div>
            <button @click="showExportModal = false" class="text-gray-400 hover:text-gray-600 transition-colors">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>
          <div class="px-6 pb-6 space-y-6">
            <div>
              <p class="text-sm font-medium text-gray-700 mb-3">Формат файла</p>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button @click="exportFormat = 'xlsx'" :class="exportFormat==='xlsx' ? 'ring-2 ring-blue-500 bg-blue-50' : 'hover:bg-gray-50'" class="p-3 border border-gray-200 rounded-xl text-sm font-medium text-gray-700 flex items-center justify-center gap-2 transition-all">
                  <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                  XLSX
                </button>
                <button @click="exportFormat = 'csv'" :class="exportFormat==='csv' ? 'ring-2 ring-blue-500 bg-blue-50' : 'hover:bg-gray-50'" class="p-3 border border-gray-200 rounded-xl text-sm font-medium text-gray-700 flex items-center justify-center gap-2 transition-all">
                  <i data-lucide="file-text" class="w-4 h-4"></i>
                  CSV
                </button>
                <button @click="exportFormat = 'txt'" :class="exportFormat==='txt' ? 'ring-2 ring-blue-500 bg-blue-50' : 'hover:bg-gray-50'" class="p-3 border border-gray-200 rounded-xl text-sm font-medium text-gray-700 flex items-center justify-center gap-2 transition-all">
                  <i data-lucide="file" class="w-4 h-4"></i>
                  TXT
                </button>
                <button @click="exportFormat = 'json'" :class="exportFormat==='json' ? 'ring-2 ring-blue-500 bg-blue-50' : 'hover:bg-gray-50'" class="p-3 border border-gray-200 rounded-xl text-sm font-medium text-gray-700 flex items-center justify-center gap-2 transition-all">
                  <i data-lucide="braces" class="w-4 h-4"></i>
                  JSON
                </button>
              </div>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-700 mb-3">Какие кампании</p>
              <div class="flex flex-wrap gap-2">
                <button @click="toggleStatusAll({target:{checked:true}})" class="px-3 py-1.5 rounded-full border text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">Все</button>
                <button @click="exportStatuses = toggleChip(exportStatuses,'sent')" :class="chipClass('sent')" class="px-3 py-1.5 rounded-full border text-sm">Выполненные</button>
                <button @click="exportStatuses = toggleChip(exportStatuses,'sending')" :class="chipClass('sending')" class="px-3 py-1.5 rounded-full border text-sm">В очереди</button>
                <button @click="exportStatuses = toggleChip(exportStatuses,'draft')" :class="chipClass('draft')" class="px-3 py-1.5 rounded-full border text-sm">Черновики</button>
                <button @click="exportStatuses = toggleChip(exportStatuses,'failed')" :class="chipClass('failed')" class="px-3 py-1.5 rounded-full border text-sm">Ошибки</button>
                <button @click="exportStatuses = toggleChip(exportStatuses,'pending')" :class="chipClass('pending')" class="px-3 py-1.5 rounded-full border text-sm">Ожидает модерации</button>
                <button @click="exportStatuses = toggleChip(exportStatuses,'approved')" :class="chipClass('approved')" class="px-3 py-1.5 rounded-full border text-sm">Одобрено</button>
                <button @click="exportStatuses = toggleChip(exportStatuses,'rejected')" :class="chipClass('rejected')" class="px-3 py-1.5 rounded-full border text-sm">Отклонено</button>
              </div>
              <p class="mt-2 text-xs text-gray-500">Экспортируются все кампании с выбранными статусами.</p>
            </div>
          </div>
          <div class="px-6 py-4 bg-gray-50 border-t flex justify-end gap-2">
            <button @click="showExportModal = false" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-white">Отмена</button>
            <button @click="confirmExport()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm">Экспорт</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function sentCampaigns() {
      return {
        searchTerm: '',
        statusFilter: 'All',
        senderFilter: 'All',
        expandedRows: new Set(),
        currentPage: 1,
        itemsPerPage: 6,
        campaigns: [],
        count: 0,
        num_pages: 1,
        showDeleteConfirm: null,
        showStatsModal: false,
        showPreviewModal: false,
        selectedCampaign: null,
        isRetrying: false,
        exportFormat: 'xlsx',
        showExportModal: false,
        exportStatuses: [],
        exportStatusSelection: [],

        isAdmin: false, // Добавляем переменную isAdmin
        sidebarItems: [
          { name: 'Панель управления', active: false },
          { name: 'Кампании', active: true },
          { name: 'Шаблоны', active: false },
          { name: 'Списки контактов', active: false },
          { name: 'Отправители', active: false },
          { name: 'Домены', active: false },
          { name: 'Настройки', active: false }
        ],

        init() {
          lucide.createIcons();
          this.loadCampaigns();
          
          // Автоматическое обновление данных каждые 5 секунд для кампаний в статусе "sending"
          this.autoRefreshInterval = setInterval(() => {
            const hasSendingCampaigns = this.campaigns.some(campaign => campaign.status === 'sending');
            if (hasSendingCampaigns) {
              this.loadCampaigns();
            }
          }, 5000);
        },

        // Очистка интервала при уничтожении компонента
        destroy() {
          if (this.autoRefreshInterval) {
            clearInterval(this.autoRefreshInterval);
          }
        },

        async loadCampaigns(page = this.currentPage) {
          try {
            const response = await fetch(`/campaigns/api/campaigns/?page=${page}&page_size=${this.itemsPerPage}`, {
              credentials: 'same-origin',
              headers: {
                'Accept': 'application/json',
                'X-CSRFToken': document.cookie.split(';').map(c => c.trim())
                  .find(c => c.startsWith('csrftoken='))
                  ?.split('=')[1] || ''
              }
            });
            if (!response.ok) {
              console.error('Failed to load campaigns:', response.status, response.statusText);
              throw new Error('Failed to load campaigns');
            }
            const data = await response.json();
            this.campaigns = data.results || [];
            this.count = data.count || 0;
            this.currentPage = data.page || 1;
            this.num_pages = data.num_pages || 1;
            this.$nextTick(() => {
              lucide.createIcons();
            });
          } catch (error) {
            console.error('Error loading campaigns:', error);
          }
        },



        // Обновляем отображение списков контактов
        getContactListsDisplay(campaign) {
          if (!campaign.contact_lists_detail || !Array.isArray(campaign.contact_lists_detail)) {
            return 'Нет списков';
          }
          return campaign.contact_lists_detail.map(list => list.name).join(', ');
        },

        getStatusDisplay(status) {
          const statusMap = {
            'draft': 'Черновик',
            'sending': 'Отправляется',
            'completed': 'Завершена'
          };
          return statusMap[status] || status;
        },

        formatDate(dateString) {
          if (!dateString) return 'Не отправлено';
          const date = new Date(dateString);
          return date.toLocaleDateString('ru-RU') + ' в ' + date.toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'});
        },

        filteredCampaigns() {
          const filtered = this.campaigns.filter(campaign => {
            const matchesSearch = campaign.name.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                                campaign.subject.toLowerCase().includes(this.searchTerm.toLowerCase());
            const matchesStatus = this.statusFilter === 'All' || campaign.status === this.statusFilter;
            const matchesSender = this.senderFilter === 'All' || 
              (campaign.sender_email && campaign.sender_email.email === this.senderFilter);
            return matchesSearch && matchesStatus && matchesSender;
          });

          // Пересоздаем иконки после фильтрации
          this.$nextTick(() => {
            lucide.createIcons();
          });

          return filtered;
        },

        totalPages() {
          return this.num_pages || 1;
        },
        paginatedCampaigns() {
          // Теперь серверная пагинация, возвращаем просто this.campaigns
          return this.campaigns;
        },

        // Функция для получения видимых страниц в пагинаторе
        getVisiblePages() {
          const total = this.totalPages();
          const current = this.currentPage;
          const pages = [];
          
          // Определяем диапазон страниц для отображения
          let start = Math.max(1, current - 2);
          let end = Math.min(total, current + 2);
          
          // Если мы близко к началу, показываем больше страниц справа
          if (current <= 3) {
            end = Math.min(total, 5);
          }
          
          // Если мы близко к концу, показываем больше страниц слева
          if (current >= total - 2) {
            start = Math.max(1, total - 4);
          }
          
          // Генерируем массив страниц
          for (let i = start; i <= end; i++) {
            pages.push(i);
          }
          
          return pages;
        },

        // Функция для перехода на страницу
        async goToPage(page) {
          if (page < 1 || page > this.totalPages() || page === this.currentPage) {
            return;
          }
          
          this.currentPage = page;
          await this.loadCampaigns(page);
        },

        toggleRowExpansion(id) {
          if (this.expandedRows.has(id)) {
            this.expandedRows.delete(id);
          } else {
            this.expandedRows.add(id);
          }
          
          // Пересоздаем иконки после раскрытия/сворачивания
          this.$nextTick(() => {
            lucide.createIcons();
          });
        },

        getStatusColor(status) {
          switch (status) {
            case 'sent': return 'bg-green-100 text-green-800 border-green-200';
            case 'draft': return 'bg-gray-100 text-gray-800 border-gray-200';
            case 'sending': return 'bg-blue-100 text-blue-800 border-blue-200';
            case 'pending': return 'bg-yellow-100 text-yellow-800 border-yellow-200';
            case 'approved': return 'bg-emerald-100 text-emerald-800 border-emerald-200';
            case 'rejected': return 'bg-red-100 text-red-800 border-red-200';
            case 'failed': return 'bg-orange-100 text-orange-800 border-orange-200';
            default: return 'bg-gray-100 text-gray-800 border-gray-200';
          }
        },

        uniqueSenders() {
          return [...new Set(this.campaigns
            .filter(c => c.sender_email && c.sender_email.email)
            .map(c => c.sender_email.email))];
        },

        // helpers for export chips
        chipClass(status) {
          const active = this.exportStatuses.includes(status);
          return active ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
        },
        toggleChip(arr, value) {
          return arr.includes(value) ? arr.filter(v => v !== value) : [...arr, value];
        },

        async deleteCampaign() {
          if (!this.showDeleteConfirm) return;
          
          try {
            const response = await fetch(`/campaigns/api/campaigns/${this.showDeleteConfirm}/`, {
              method: 'DELETE',
              credentials: 'same-origin',
              headers: {
                'X-CSRFToken': document.cookie.split(';').map(c => c.trim())
                  .find(c => c.startsWith('csrftoken='))
                  ?.split('=')[1] || ''
              }
            });

            if (!response.ok) {
              throw new Error('Failed to delete campaign');
            }

            // Удаляем рассылку из списка
            this.campaigns = this.campaigns.filter(c => c.id !== this.showDeleteConfirm);
            
            // Закрываем модальное окно
            this.showDeleteConfirm = null;
            
            // Пересоздаем иконки
            this.$nextTick(() => {
              lucide.createIcons();
            });
          } catch (error) {
            console.error('Error deleting campaign:', error);
            alert('Ошибка при удалении рассылки');
          }
        },

        showStats(campaign) {
          this.selectedCampaign = campaign;
          this.showStatsModal = true;
          this.$nextTick(() => {
            lucide.createIcons();
          });
        },

        showPreview(campaign) {
          this.selectedCampaign = campaign;
          this.showPreviewModal = true;
          this.$nextTick(() => {
            lucide.createIcons();
          });
        },

        async retryCampaign(campaign) {
          if (this.isRetrying) return;
          
          this.isRetrying = true;
          try {
            const response = await fetch(`/campaigns/api/campaigns/${campaign.id}/retry/`, {
              method: 'POST',
              credentials: 'same-origin',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRFToken': document.cookie.split(';').map(c => c.trim())
                  .find(c => c.startsWith('csrftoken='))
                  ?.split('=')[1] || ''
              }
            });

            if (!response.ok) {
              throw new Error('Failed to retry campaign');
            }

            const data = await response.json();
            
            // Обновляем статус кампании в списке
            const campaignIndex = this.campaigns.findIndex(c => c.id === campaign.id);
            if (campaignIndex !== -1) {
              this.campaigns[campaignIndex] = {
                ...this.campaigns[campaignIndex],
                status: data.status,
                status_display: data.status_display
              };
            }

            // Показываем уведомление об успехе
            alert('Рассылка успешно запущена повторно');
            
            // Перезагружаем список кампаний через 5 секунд
            setTimeout(() => {
              this.loadCampaigns();
            }, 5000);

          } catch (error) {
            console.error('Error retrying campaign:', error);
            alert('Ошибка при повторной отправке рассылки');
          } finally {
            this.isRetrying = false;
          }
        },

        async exportSelected() {
          this.showExportModal = true;
        },
        toggleStatusAll(evt) {
          if (evt.target.checked) {
            this.exportStatuses = ['sent','sending','draft','failed','pending','approved','rejected'];
          } else {
            this.exportStatuses = [];
          }
        },
        async confirmExport() {
          try {
            const payload = { statuses: this.exportStatuses, format: this.exportFormat };
            const response = await fetch('/campaigns/api/campaigns/export/', {
              method: 'POST',
              credentials: 'same-origin',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRFToken': document.cookie.split(';').map(c => c.trim()).find(c => c.startsWith('csrftoken='))?.split('=')[1] || ''
              },
              body: JSON.stringify(payload)
            });
            if (!response.ok) {
              throw new Error('Failed to export reports');
            }
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `campaign_reports.${this.exportFormat === 'xlsx' ? 'xlsx' : this.exportFormat}`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            this.showExportModal = false;
          } catch (e) {
            alert('Ошибка экспорта отчета');
          }
        }
      }
    }
  </script>
</body>
</html>
